<!DOCTYPE html>
<html>
<head>
    <title>AI Interview Coach - Working Version</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { width: 100%; padding: 8px; margin: 5px 0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .question { background: white; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .options { margin: 10px 0; }
        .option { margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; }
        .result { background: #e8f5e8; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .error { background: #ffe8e8; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .info { background: #e7f3ff; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🤖 AI Interview Coach</h1>
        <p class="info">✅ Backend is working! Questions are generated by DeepSeek-R1:32b</p>
        
        <div id="setup">
            <h2>Interview Setup</h2>
            <div class="form-group">
                <label>Target Role:</label>
                <select id="role">
                    <option value="Software Engineer">Software Engineer</option>
                    <option value="Data Scientist">Data Scientist</option>
                    <option value="Data Analyst">Data Analyst</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Experience Level:</label>
                <select id="level">
                    <option value="entry">Entry Level</option>
                    <option value="mid" selected>Mid Level</option>
                    <option value="senior">Senior Level</option>
                </select>
            </div>
            
            <button onclick="startInterview()">Start Interview</button>
            <button onclick="testConnection()" style="background: #28a745;">Test Connection</button>
        </div>
        
        <div id="interview" class="hidden">
            <h2>Round <span id="round-number">1</span> - <span id="question-count">0</span> Questions</h2>
            <p><strong>Session ID:</strong> <span id="session-id"></span></p>
            <p><strong>Role:</strong> <span id="current-role"></span> | <strong>Level:</strong> <span id="current-level"></span></p>
            
            <div id="questions-container"></div>
            
            <button onclick="submitRound()">Submit Answers</button>
            <button onclick="restartInterview()" style="background: #6c757d;">Restart Interview</button>
        </div>
        
        <div id="results" class="hidden"></div>
    </div>

    <script>
        let currentSession = null;
        let currentRound = 1;
        let currentQuestions = [];
        const API_BASE = 'http://localhost:8000';
        
        async function testConnection() {
            try {
                const response = await fetch(API_BASE + '/');
                const data = await response.json();
                showMessage(`✅ Backend connected: ${data.message}`, 'info');
            } catch (error) {
                showMessage(`❌ Connection failed. Make sure you ran: python app.py`, 'error');
            }
        }
        
        async function startInterview() {
            const role = document.getElementById('role').value;
            const level = document.getElementById('level').value;
            
            showMessage('🔄 Starting interview...', 'info');
            
            try {
                const response = await fetch(API_BASE + '/start', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        target_role: role, 
                        experience_level: level 
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                
                const data = await response.json();
                console.log('Interview started:', data);
                
                if (data.session_id) {
                    currentSession = data.session_id;
                    currentQuestions = data.questions || [];
                    
                    // Update UI
                    document.getElementById('session-id').textContent = data.session_id.substring(0, 8) + '...';
                    document.getElementById('current-role').textContent = role;
                    document.getElementById('current-level').textContent = level;
                    document.getElementById('question-count').textContent = data.total_questions || currentQuestions.length;
                    
                    document.getElementById('setup').classList.add('hidden');
                    document.getElementById('interview').classList.remove('hidden');
                    
                    displayQuestions(currentQuestions);
                    showMessage(`✅ Interview started! ${data.total_questions} questions generated.`, 'result');
                }
                
            } catch (error) {
                showMessage(`❌ Error: ${error.message}`, 'error');
                console.error('Start error:', error);
            }
        }
        
        function displayQuestions(questions) {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.id = `question-${index}`;
                
                let optionsHTML = '';
                if (q.options && q.options.length > 0) {
                    // Filter out empty options
                    const validOptions = q.options.filter(opt => opt && opt.trim() !== '');
                    if (validOptions.length > 0) {
                        optionsHTML = `
                            <div class="options">
                                <strong>Options:</strong>
                                ${validOptions.map((opt, i) => `
                                    <div class="option">
                                        <input type="radio" name="q${index}" value="${opt}" id="q${index}_${i}">
                                        <label for="q${index}_${i}">${opt}</label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                }
                
                questionDiv.innerHTML = `
                    <h3>Question ${index + 1}</h3>
                    <p><strong>Type:</strong> ${q.type} | <strong>Topic:</strong> ${q.topic || 'General'} | <strong>Difficulty:</strong> ${q.difficulty || 'Medium'}</p>
                    <p>${q.text}</p>
                    ${optionsHTML || `
                        <div class="form-group">
                            <label for="answer-${index}">Your Answer:</label>
                            <input type="text" id="answer-${index}" placeholder="Type your answer here..." style="width: 100%; padding: 8px;">
                        </div>
                    `}
                `;
                container.appendChild(questionDiv);
            });
        }
        
        async function submitRound() {
            // Collect answers
            const answers = [];
            
            currentQuestions.forEach((q, index) => {
                let userAnswer = '';
                
                if (q.options && q.options.length > 0) {
                    const selected = document.querySelector(`input[name="q${index}"]:checked`);
                    userAnswer = selected ? selected.value : '';
                } else {
                    const textInput = document.getElementById(`answer-${index}`);
                    userAnswer = textInput ? textInput.value : '';
                }
                
                // Prepare answer object
                const answerObj = {
                    question_id: q.id,
                    question_text: q.text,
                    type: q.type,
                    topic: q.topic || 'General',
                    difficulty: q.difficulty || 'medium',
                    options: q.options || [],
                    correct_answer: q.correct_answer || '',
                    user_answer: userAnswer,
                    time_spent: 0
                };
                
                answers.push(answerObj);
            });
            
            // Check if all questions answered
            const unanswered = answers.filter(a => !a.user_answer.trim());
            if (unanswered.length > 0) {
                showMessage(`⚠️ You have ${unanswered.length} unanswered questions. Please answer all questions.`, 'error');
                return;
            }
            
            showMessage('🔄 Submitting answers...', 'info');
            
            try {
                const response = await fetch(API_BASE + '/submit', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSession,
                        answers: answers,
                        time_spent: 300 // 5 minutes for example
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                
                const data = await response.json();
                console.log('Submit response:', data);
                showResults(data);
                
            } catch (error) {
                showMessage(`❌ Error submitting: ${error.message}`, 'error');
                console.error('Submit error:', error);
            }
        }
        
        function showResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            if (data.status === 'failed') {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Round ${data.round} Failed</h3>
                        <p><strong>Score:</strong> ${data.score || 0}% (Required: ${data.passing_score || 70}%)</p>
                        <p><strong>Message:</strong> ${data.message || 'Better luck next time!'}</p>
                        <button onclick="restartInterview()">Try Again</button>
                    </div>
                `;
            } else if (data.status === 'completed') {
                resultsDiv.innerHTML = `
                    <div class="result">
                        <h3>🎉 Interview Completed Successfully!</h3>
                        <p><strong>Final Score:</strong> ${data.score || 0}%</p>
                        <p><strong>Message:</strong> ${data.message || 'Congratulations!'}</p>
                        <button onclick="restartInterview()">Start New Interview</button>
                    </div>
                `;
                document.getElementById('interview').classList.add('hidden');
            } else if (data.status === 'next_round') {
                resultsDiv.innerHTML = `
                    <div class="result">
                        <h3>✅ Round ${currentRound} Passed!</h3>
                        <p><strong>Score:</strong> ${data.previous_score || 0}%</p>
                        <p><strong>Moving to Round ${data.current_round}...</strong></p>
                    </div>
                `;
                currentRound = data.current_round;
                currentQuestions = data.questions || [];
                
                document.getElementById('round-number').textContent = currentRound;
                document.getElementById('question-count').textContent = currentQuestions.length;
                
                // Clear previous answers and show new questions
                setTimeout(() => {
                    displayQuestions(currentQuestions);
                }, 2000);
            }
            
            resultsDiv.classList.remove('hidden');
        }
        
        function restartInterview() {
            currentSession = null;
            currentRound = 1;
            currentQuestions = [];
            
            document.getElementById('setup').classList.remove('hidden');
            document.getElementById('interview').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            
            document.getElementById('round-number').textContent = '1';
            document.getElementById('question-count').textContent = '0';
            document.getElementById('questions-container').innerHTML = '';
            
            showMessage('Interview reset. Start a new interview above.', 'info');
        }
        
        function showMessage(message, className) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="${className}">${message}</div>`;
            resultsDiv.classList.remove('hidden');
        }
        
        // Test connection on page load
        window.onload = testConnection;
    </script>
</body>
</html>
